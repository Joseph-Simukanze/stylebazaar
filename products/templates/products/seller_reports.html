{% extends "base.html" %}
{% load humanize %}
{% load custom_filters %}

{% block title %}Sales Reports | Style Bazaar{% endblock %}

{% block extra_head %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Icons: Lucide -->
<script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

<!-- PDF Export: html2pdf -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<!-- CSV Export: SheetJS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<!-- AOS Animation -->
<link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
<script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>

<style>
    :root {
        --primary: #ec4899;
        --primary-light: #fdf2f8;
        --primary-dark: #be185d;
        --text: #1f2937;
        --text-light: #6b7280;
    }

    .stat-card {
        @apply bg-white dark:bg-gray-800 rounded-3xl shadow-lg p-8 
               hover:shadow-2xl hover:-translate-y-2 transition-all duration-300
               border border-gray-100 dark:border-gray-700 relative overflow-hidden;
    }
    .stat-card::before {
        content: '';
        @apply absolute inset-0 opacity-0 hover:opacity-10 transition-opacity;
        background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    }
    .stat-icon {
        @apply w-16 h-16 rounded-2xl flex items-center justify-center text-3xl shadow-lg;
    }

    .chart-card {
        @apply bg-white dark:bg-gray-800 rounded-3xl shadow-xl p-8 border border-gray-100 dark:border-gray-700;
    }

    .filter-bar {
        @apply bg-white dark:bg-gray-800 rounded-2xl shadow-md p-6 mb-10 border border-gray-200 dark:border-gray-700;
    }

    .export-btn {
        @apply inline-flex items-center gap-2 px-5 py-3 rounded-xl font-medium text-white 
               transition-all hover:scale-105 shadow-lg;
    }

    .th {
        @apply px-6 py-4 text-left text-xs font-bold text-gray-600 dark:text-gray-400 uppercase tracking-wider bg-gray-50 dark:bg-gray-700/50;
    }
    .td {
        @apply px-6 py-5 text-base whitespace-nowrap border-t border-gray-100 dark:border-gray-700;
    }

    tbody tr {
        @apply hover:bg-pink-50/50 dark:hover:bg-pink-900/20 transition-colors;
    }

    .progress-bar {
        @apply h-3 rounded-full bg-gray-200 dark:bg-gray-600 w-32 overflow-hidden;
    }
    .progress-fill {
        @apply h-full bg-gradient-to-r from-pink-500 to-purple-600 transition-all duration-1000 ease-out;
        width: 0%;
    }

    .table-container {
        @apply overflow-x-auto rounded-b-3xl;
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 dark:bg-gray-900 py-16 px-4 transition-colors duration-500">
    <div class="max-w-7xl mx-auto">

        <!-- Header -->
        <div class="text-center md:text-left mb-10" data-aos="fade-down">
            <h1 class="text-5xl md:text-6xl font-extrabold text-gray-900 dark:text-white mb-4">
                Sales Reports & Analytics
            </h1>
            <p class="text-xl text-gray-600 dark:text-gray-300">
                Real-time insights into revenue, orders, and top-performing products
            </p>
        </div>

        <!-- Filter & Export Bar -->
        <div class="filter-bar" data-aos="fade-up">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-6">
                <div class="flex flex-col sm:flex-row gap-4 items-start sm:items-center">
                    <label class="font-medium text-gray-700 dark:text-gray-300">Date Range:</label>
                    <input type="date" id="dateFrom" class="px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 dark:bg-gray-700">
                    <span class="text-gray-500">to</span>
                    <input type="date" id="dateTo" class="px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 dark:bg-gray-700">
                    <button id="applyFilter" class="px-6 py-2 bg-primary text-white rounded-lg hover:bg-primary-dark transition">
                        Apply Filter
                    </button>
                    <button id="resetFilter" class="px-6 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition">
                        Reset
                    </button>
                </div>

                <div class="flex gap-3">
                    <button id="exportCSV" class="export-btn bg-green-600 hover:bg-green-700">
                        <i data-lucide="download"></i> CSV
                    </button>
                    <button id="exportPDF" class="export-btn bg-red-600 hover:bg-red-700">
                        <i data-lucide="file-down"></i> PDF
                    </button>
                </div>
            </div>
        </div>

        <!-- Summary Stats -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8 mb-16">
            <!-- Cards remain the same, just with better AOS delays -->
            <div class="stat-card" data-aos="zoom-in" data-aos-delay="100">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Active Products</p>
                        <p class="text-5xl font-extrabold text-gray-900 dark:text-white mt-2">{{ products|intcomma }}</p>
                        <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">Currently listed</p>
                    </div>
                    <div class="stat-icon bg-pink-100 dark:bg-pink-900/40">üì¶</div>
                </div>
            </div>

            <div class="stat-card" data-aos="zoom-in" data-aos-delay="200">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Total Revenue</p>
                        <p class="text-5xl font-extrabold text-green-600 dark:text-green-400 mt-2">K{{ total_revenue|floatformat:2|intcomma }}</p>
                        <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">All time earnings</p>
                    </div>
                    <div class="stat-icon bg-green-100 dark:bg-green-900/40">üí∞</div>
                </div>
            </div>

            <div class="stat-card" data-aos="zoom-in" data-aos-delay="300">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Paid Orders</p>
                        <p class="text-5xl font-extrabold text-purple-600 dark:text-purple-400 mt-2">{{ sales_count|intcomma }}</p>
                        <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">Completed transactions</p>
                    </div>
                    <div class="stat-icon bg-purple-100 dark:bg-purple-900/40">üßæ</div>
                </div>
            </div>

            <div class="stat-card" data-aos="zoom-in" data-aos-delay="400">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Avg Order Value</p>
                        <p class="text-5xl font-extrabold text-blue-600 dark:text-blue-400 mt-2">
                            {% if sales_count > 0 %}K{{ average_order_value|floatformat:2|intcomma }}{% else %}K0.00{% endif %}
                        </p>
                        <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">Per completed order</p>
                    </div>
                    <div class="stat-icon bg-blue-100 dark:bg-blue-900/40">üìä</div>
                </div>
            </div>
        </div>

        <!-- Charts -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-16">
            <div class="chart-card" data-aos="fade-right">
                <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">Monthly Revenue Trend</h2>
                <div class="relative h-80">
                    <canvas id="monthlySalesChart"></canvas>
                </div>
            </div>

            <div class="chart-card" data-aos="fade-left">
                <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">Top Selling Products</h2>
                <div class="relative h-80">
                    <canvas id="topProductsChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Sales Table -->
        <div class="bg-white dark:bg-gray-800 rounded-3xl shadow-2xl overflow-hidden" data-aos="fade-up" id="reportTable">
            <div class="p-10 border-b border-gray-200 dark:border-gray-700">
                <h2 class="text-3xl font-extrabold text-gray-900 dark:text-white">
                    Product Sales Details
                </h2>
                <p class="text-gray-600 dark:text-gray-400 mt-3">Detailed breakdown of sales by product</p>
            </div>

            <div class="table-container">
                <table class="min-w-full" id="salesTable">
                    <thead>
                        <tr>
                            <th class="th">Product</th>
                            <th class="th text-center">Qty Sold</th>
                            <th class="th text-right">Revenue</th>
                            <th class="th text-right">% of Total</th>
                        </tr>
                    </thead>
                    <tbody id="salesTableBody">
                        {% for item in sales %}
                        <tr data-date="{{ item.last_sale_date|date:"Y-m-d" }}">
                            <td class="td">
                                <div class="flex items-center gap-4">
                                    {% if item.product_main_image %}
                                    <img src="{{ item.product_main_image }}" alt="{{ item.product__name }}"
                                         class="w-16 h-16 rounded-xl object-cover shadow-md">
                                    {% else %}
                                    <div class="w-16 h-16 bg-gray-200 dark:bg-gray-600 rounded-xl flex items-center justify-center text-2xl shadow-md">
                                        üõçÔ∏è
                                    </div>
                                    {% endif %}
                                    <p class="font-semibold text-gray-900 dark:text-white text-lg">{{ item.product__name }}</p>
                                </div>
                            </td>
                            <td class="td text-center font-medium">{{ item.total_quantity|intcomma }}</td>
                            <td class="td text-right font-bold text-green-600 dark:text-green-400">
                                K{{ item.total_revenue|floatformat:2|intcomma }}
                            </td>
                            <td class="td text-right">
                                <div class="flex items-center justify-end gap-3">
                                    <div class="progress-bar">
                                        <div class="progress-fill" data-width="{{ item.percentage }}"></div>
                                    </div>
                                    <span class="font-bold text-gray-900 dark:text-white w-16">
                                        {% if total_revenue > 0 %}{{ item.percentage|floatformat:1 }}%{% else %}0%{% endif %}
                                    </span>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="4" class="py-24 text-center text-gray-500 dark:text-gray-400">
                                <div class="text-7xl mb-6 opacity-50">üìä</div>
                                <p class="text-2xl font-bold">No sales recorded yet</p>
                                <p class="mt-3">Your sales will appear here once customers start purchasing</p>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    AOS.init({ duration: 800, once: true });
    lucide.createIcons();

    const isDark = document.documentElement.classList.contains('dark');
    const textColor = isDark ? '#e5e7eb' : '#374151';
    const gridColor = isDark ? '#37415150' : '#e5e7eb30';

    // Charts (same as before)
    new Chart(document.getElementById('monthlySalesChart'), {
        type: 'line',
        data: {
            labels: {{ monthly_labels|safe }},
            datasets: [{
                label: 'Revenue (K ZMW)',
                data: {{ monthly_revenue|safe }},
                borderColor: '#ec4899',
                backgroundColor: 'rgba(236, 72, 153, 0.15)',
                borderWidth: 4,
                tension: 0.4,
                fill: true,
                pointRadius: 5,
                pointHoverRadius: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: isDark ? 'rgba(0,0,0,0.9)' : 'rgba(255,255,255,0.95)',
                    borderColor: '#ec4899',
                    borderWidth: 2,
                    callbacks: { label: ctx => `K${ctx.parsed.y.toLocaleString(undefined, {minimumFractionDigits: 2})} ZMW` }
                }
            },
            scales: {
                y: { beginAtZero: true, grid: { color: gridColor }, ticks: { color: textColor } },
                x: { grid: { display: false }, ticks: { color: textColor } }
            }
        }
    });

    new Chart(document.getElementById('topProductsChart'), {
        type: 'bar',
        data: {
            labels: {{ top_product_names|safe }},
            datasets: [{
                data: {{ top_product_revenue|safe }},
                backgroundColor: 'rgba(236, 72, 153, 0.85)',
                borderColor: '#ec4899',
                borderWidth: 2,
                borderRadius: 10
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: { label: ctx => `K${ctx.parsed.y.toLocaleString(undefined, {minimumFractionDigits: 2})} ZMW` }
                }
            },
            scales: {
                y: { beginAtZero: true, grid: { color: gridColor }, ticks: { color: textColor } },
                x: { grid: { display: false }, ticks: { color: textColor, maxRotation: 45 } }
            }
        }
    });

    // Animate progress bars
    setTimeout(() => {
        document.querySelectorAll('.progress-fill').forEach(bar => {
            bar.style.width = bar.dataset.width + '%';
        });
    }, 500);

    // Date Filtering
    const tableBody = document.getElementById('salesTableBody');
    const rows = tableBody.querySelectorAll('tr[data-date]');
    const dateFromInput = document.getElementById('dateFrom');
    const dateToInput = document.getElementById('dateTo');

    function applyDateFilter() {
        const from = dateFromInput.value ? new Date(dateFromInput.value) : null;
        const to = dateToInput.value ? new Date(dateToInput.value) : null;

        rows.forEach(row => {
            const rowDate = row.dataset.date ? new Date(row.dataset.date) : null;
            if (!rowDate) {
                row.style.display = '';
                return;
            }

            const show = (!from || rowDate >= from) && (!to || rowDate <= to);
            row.style.display = show ? '' : 'none';
        });
    }

    document.getElementById('applyFilter').addEventListener('click', applyDateFilter);
    document.getElementById('resetFilter').addEventListener('click', () => {
        dateFromInput.value = '';
        dateToInput.value = '';
        rows.forEach(row => row.style.display = '');
    });

    // Export to CSV
    document.getElementById('exportCSV').addEventListener('click', () => {
        const visibleRows = Array.from(tableBody.querySelectorAll('tr'))
            .filter(row => row.style.display !== 'none' && row.querySelector('td'));

        const data = visibleRows.map(row => {
            const cells = row.querySelectorAll('td');
            return [
                cells[0].innerText.trim().split('\n').pop().trim(), // Product name
                cells[1].innerText.trim(),
                cells[2].innerText.trim(),
                cells[3].querySelector('span').innerText.trim()
            ];
        });

        data.unshift(['Product', 'Qty Sold', 'Revenue', '% of Total']);

        const ws = XLSX.utils.aoa_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Sales Report");
        XLSX.writeFile(wb, "sales_report.csv");
    });

    // Export to PDF
    document.getElementById('exportPDF').addEventListener('click', () => {
        const element = document.getElementById('reportTable');
        html2pdf()
            .set({
                margin: 1,
                filename: 'sales_report.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
            })
            .from(element)
            .save();
    });
</script>
{% endblock %}