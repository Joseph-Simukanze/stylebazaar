{% extends "base.html" %}
{% load static %}

{% block title %}Send Notification | Style Bazaar{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 dark:bg-gray-900 py-16 px-4 transition-colors duration-500">
    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <header class="text-center mb-16">
            <h1 class="text-5xl md:text-6xl font-extrabold text-gray-900 dark:text-white mb-6">
                Send Notification
            </h1>
            <p class="text-xl md:text-2xl text-gray-600 dark:text-gray-300 max-w-4xl mx-auto leading-relaxed">
                Connect with your buyers ‚Äî send order updates, shipping alerts, promotions, or personal messages
            </p>
        </header>

        <!-- Messages -->
        {% if messages %}
        <div class="max-w-4xl mx-auto space-y-4 mb-12">
            {% for message in messages %}
            <div role="alert" class="p-6 rounded-2xl shadow-lg text-center transition-all duration-500
                {% if message.tags == 'success' %}
                    bg-green-100 dark:bg-green-900/40 text-green-800 dark:text-green-200 border border-green-300 dark:border-green-700
                {% elif message.tags == 'error' %}
                    bg-red-100 dark:bg-red-900/40 text-red-800 dark:text-red-200 border border-red-300 dark:border-red-700
                {% else %}
                    bg-blue-100 dark:bg-blue-900/40 text-blue-800 dark:text-blue-200 border border-blue-300 dark:border-blue-700
                {% endif %}">
                <p class="text-lg font-medium">{{ message }}</p>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Mode Tabs -->
        <nav class="flex justify-center mb-12" aria-label="Notification sending mode">
            <div class="inline-flex bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-2 border border-gray-200 dark:border-gray-700">
                <button
                    type="button"
                    data-mode="single"
                    class="tab-btn active px-8 py-4 rounded-xl font-bold text-lg transition-all duration-300 bg-primary text-white shadow-md"
                    aria-selected="true"
                >
                    Single Buyer
                </button>
                <button
                    type="button"
                    data-mode="bulk"
                    class="tab-btn px-8 py-4 rounded-xl font-bold text-lg transition-all duration-300 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700"
                    aria-selected="false"
                >
                    All Buyers
                </button>
                <button
                    type="button"
                    data-mode="template"
                    class="tab-btn px-8 py-4 rounded-xl font-bold text-lg transition-all duration-300 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700"
                    aria-selected="false"
                >
                    Quick Templates
                </button>
            </div>
        </nav>

        <!-- Main Form Card -->
        <div class="bg-white dark:bg-gray-800 rounded-3xl shadow-2xl overflow-hidden max-w-5xl mx-auto">
            <div class="bg-gradient-to-r from-indigo-600 to-purple-700 dark:from-indigo-800 dark:to-purple-900 text-white p-10 text-center">
                <h2 class="text-4xl font-extrabold">Compose Message</h2>
                <p class="mt-3 text-indigo-100">Reach your customers with care</p>
            </div>

            <div class="p-10 md:p-14">
                <form method="post" novalidate>
                    {% csrf_token %}
                    <input type="hidden" name="send_mode" id="send-mode" value="single">

                    <!-- Single Buyer Mode -->
                    <div id="single-mode" class="mode-content space-y-10">
                        <div>
                            <label for="buyer" class="block text-xl font-bold text-gray-800 dark:text-gray-200 mb-3">
                                Select Buyer <span class="text-red-500">*</span>
                            </label>
                            <select
                                name="buyer"
                                id="buyer"
                                required
                                class="w-full px-6 py-4 text-lg border-2 border-gray-300 dark:border-gray-600 rounded-2xl focus:outline-none focus:border-primary focus:ring-4 focus:ring-primary/20 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 transition-all duration-300"
                            >
                                <option value="">-- Choose a buyer --</option>
                                {% for buyer in buyers %}
                                <option value="{{ buyer.id }}">
                                    {{ buyer.get_full_name|default:buyer.username }} ({{ buyer.email }})
                                    {% if buyer.order_count > 0 %}
                                        ‚Äì {{ buyer.order_count }} order{{ buyer.order_count|pluralize }}
                                    {% endif %}
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <div>
                            <label for="order_id_single" class="block text-xl font-bold text-gray-800 dark:text-gray-200 mb-3">
                                Related Order (Optional)
                            </label>
                            <select
                                name="order_id"
                                id="order_id_single"
                                class="w-full px-6 py-4 text-lg border-2 border-gray-300 dark:border-gray-600 rounded-2xl focus:outline-none focus:border-primary focus:ring-4 focus:ring-primary/20 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 transition-all duration-300"
                            >
                                <option value="">-- No specific order --</option>
                                {% for order in recent_orders %}
                                <option value="{{ order.id }}">
                                    Order #SB-{{ order.id }} ‚Äì {{ order.buyer.get_full_name|default:order.buyer.username }} ‚Äì {{ order.get_status_display }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <!-- Bulk Mode Warning -->
                    <div id="bulk-mode" class="mode-content hidden">
                        <div class="bg-amber-50 dark:bg-amber-900/30 border-2 border-amber-300 dark:border-amber-700 rounded-2xl p-10 text-center">
                            <div class="text-5xl mb-6">üì¢</div>
                            <p class="text-2xl font-bold text-amber-800 dark:text-amber-200 mb-4">
                                Broadcast to All Buyers
                            </p>
                            <p class="text-lg text-amber-700 dark:text-amber-300 leading-relaxed">
                                This message will be sent to <strong>{{ buyers.count }} buyer{{ buyers.count|pluralize }}</strong> who have purchased from you.
                            </p>
                            <p class="text-sm text-amber-600 dark:text-amber-400 mt-6 italic">
                                Use sparingly for important announcements or exclusive promotions only.
                            </p>
                        </div>
                    </div>

                    <!-- Template Mode -->
                    <div id="template-mode" class="mode-content hidden">
                        <p class="text-lg text-gray-600 dark:text-gray-400 mb-8">
                            Choose a pre-written template or customize your own below
                        </p>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <button
                                type="button"
                                class="template-btn p-8 bg-gradient-to-br from-emerald-50 to-teal-50 dark:from-emerald-900/30 dark:to-teal-900/30 rounded-2xl border-2 border-emerald-200 dark:border-emerald-800 hover:border-emerald-500 dark:hover:border-emerald-600 transition-all duration-300 text-left shadow-md hover:shadow-xl"
                                data-title="Your Order Has Shipped! üöö"
                                data-message="Great news! Your order #SB-{{ order_id }} has been shipped and is on its way to you. Estimated delivery: 3-5 business days. Track your package here: [insert tracking link]"
                            >
                                <div class="text-3xl mb-4">üöö</div>
                                <h4 class="font-bold text-xl text-gray-900 dark:text-white">Order Shipped</h4>
                                <p class="text-sm text-gray-600 dark:text-gray-400 mt-2">Notify buyer their package is en route</p>
                            </button>

                            <button
                                type="button"
                                class="template-btn p-8 bg-gradient-to-br from-orange-50 to-amber-50 dark:from-orange-900/30 dark:to-amber-900/30 rounded-2xl border-2 border-orange-200 dark:border-orange-800 hover:border-orange-500 dark:hover:border-orange-600 transition-all duration-300 text-left shadow-md hover:shadow-xl"
                                data-title="Shipping Update ‚Äì Slight Delay"
                                data-message="We're sorry for the inconvenience. Your order #SB-{{ order_id }} is experiencing a minor delay due to high demand. We expect to ship within the next 2-3 days. Thank you for your patience!"
                            >
                                <div class="text-3xl mb-4">‚è≥</div>
                                <h4 class="font-bold text-xl text-gray-900 dark:text-white">Shipping Delay</h4>
                                <p class="text-sm text-gray-600 dark:text-gray-400 mt-2">Inform about unexpected delays</p>
                            </button>

                            <button
                                type="button"
                                class="template-btn p-8 bg-gradient-to-br from-pink-50 to-purple-50 dark:from-pink-900/30 dark:to-purple-900/30 rounded-2xl border-2 border-pink-200 dark:border-pink-800 hover:border-pink-500 dark:hover:border-pink-600 transition-all duration-300 text-left shadow-md hover:shadow-xl"
                                data-title="Exclusive Offer Just for You! üéÅ"
                                data-message="Thank you for being a valued customer! Here's a special 15% off your next purchase as our way of saying thanks. Use code THANKYOU15 at checkout. Valid for 7 days."
                            >
                                <div class="text-3xl mb-4">üéÅ</div>
                                <h4 class="font-bold text-xl text-gray-900 dark:text-white">Special Discount</h4>
                                <p class="text-sm text-gray-600 dark:text-gray-400 mt-2">Send personalized promotion</p>
                            </button>

                            <button
                                type="button"
                                class="template-btn p-8 bg-gradient-to-br from-blue-50 to-indigo-50 dark:from-blue-900/30 dark:to-indigo-900/30 rounded-2xl border-2 border-blue-200 dark:border-blue-800 hover:border-blue-500 dark:hover:border-blue-600 transition-all duration-300 text-left shadow-md hover:shadow-xl"
                                data-title="Thank You for Your Order! üíñ"
                                data-message="Thank you so much for shopping with us! We hope you love your new items. Your satisfaction means the world to us. Don't forget to leave a review and tag us in your photos!"
                            >
                                <div class="text-3xl mb-4">üíñ</div>
                                <h4 class="font-bold text-xl text-gray-900 dark:text-white">Thank You</h4>
                                <p class="text-sm text-gray-600 dark:text-gray-400 mt-2">Post-purchase appreciation</p>
                            </button>
                        </div>
                    </div>

                    <!-- Shared Fields: Title & Message -->
                    <div class="space-y-10 mt-12 border-t-2 border-gray-200 dark:border-gray-700 pt-12">
                        <div>
                            <label for="title" class="block text-xl font-bold text-gray-800 dark:text-gray-200 mb-3">
                                Message Title <span class="text-red-500">*</span>
                            </label>
                            <input
                                type="text"
                                name="title"
                                id="title"
                                required
                                maxlength="200"
                                placeholder="e.g., Your Order is On the Way! üöö"
                                class="w-full px-6 py-5 text-lg border-2 border-gray-300 dark:border-gray-600 rounded-2xl focus:outline-none focus:border-primary focus:ring-4 focus:ring-primary/20 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 transition-all duration-300"
                            />
                        </div>

                        <div>
                            <label for="message" class="block text-xl font-bold text-gray-800 dark:text-gray-200 mb-3">
                                Message Body <span class="text-red-500">*</span>
                            </label>
                            <textarea
                                name="message"
                                id="message"
                                rows="8"
                                required
                                placeholder="Write a warm, clear message... You can use #SB-{{ order_id }} as a placeholder for the order number."
                                class="w-full px-6 py-5 text-lg border-2 border-gray-300 dark:border-gray-600 rounded-2xl focus:outline-none focus:border-primary focus:ring-4 focus:ring-primary/20 resize-vertical bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 transition-all duration-300"
                            ></textarea>
                            <p class="text-sm text-gray-500 dark:text-gray-400 mt-3">
                                Tip: Personalize with order details or offers to increase engagement
                            </p>
                        </div>
                    </div>

                    <!-- Submit -->
                    <div class="mt-12">
                        <button
                            type="submit"
                            class="w-full bg-gradient-to-r from-indigo-600 to-purple-700 hover:from-indigo-700 hover:to-purple-800 text-white py-7 rounded-2xl font-extrabold text-2xl shadow-2xl hover:shadow-3xl transition-all duration-500 transform hover:-translate-y-1 flex items-center justify-center gap-4"
                        >
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                            </svg>
                            <span id="submit-text">Send Notification</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Enhanced JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function () {
    const tabs = document.querySelectorAll('.tab-btn');
    const modes = document.querySelectorAll('.mode-content');
    const sendModeInput = document.getElementById('send-mode');
    const submitText = document.getElementById('submit-text');
    const buyerSelect = document.getElementById('buyer');
    const titleInput = document.getElementById('title');
    const messageInput = document.getElementById('message');

    // Count total buyers (excluding placeholder)
    const totalBuyers = document.querySelectorAll('#buyer option').length - 1;

    // Tab switching
    tabs.forEach(tab => {
        tab.addEventListener('click', function () {
            const mode = this.getAttribute('data-mode');

            // Update active state
            tabs.forEach(t => {
                t.classList.remove('bg-primary', 'text-white', 'shadow-md');
                t.classList.add('hover:bg-gray-100', 'dark:hover:bg-gray-700');
                t.setAttribute('aria-selected', 'false');
            });
            this.classList.add('bg-primary', 'text-white', 'shadow-md');
            this.classList.remove('hover:bg-gray-100', 'dark:hover:bg-gray-700');
            this.setAttribute('aria-selected', 'true');

            // Show/hide modes
            modes.forEach(m => m.classList.add('hidden'));
            document.getElementById(mode + '-mode').classList.remove('hidden');

            // Update form behavior
            sendModeInput.value = mode;

            if (mode === 'bulk') {
                buyerSelect.removeAttribute('required');
                submitText.textContent = `Broadcast to All ${totalBuyers} Buyer${totalBuyers !== 1 ? 's' : ''}`;
            } else {
                buyerSelect.setAttribute('required', '');
                submitText.textContent = 'Send Notification';
            }
        });
    });

    // Template selection
    document.querySelectorAll('.template-btn').forEach(btn => {
        btn.addEventListener('click', function () {
            const title = this.getAttribute('data-title');
            const message = this.getAttribute('data-message');

            titleInput.value = title;
            messageInput.value = message;

            // Optional: Flash effect
            titleInput.classList.add('ring-4', 'ring-primary/50');
            messageInput.classList.add('ring-4', 'ring-primary/50');
            setTimeout(() => {
                titleInput.classList.remove('ring-4', 'ring-primary/50');
                messageInput.classList.remove('ring-4', 'ring-primary/50');
            }, 800);
        });
    });

    // Initialize
    document.querySelector('[data-mode="single"]').click();
});
</script>
{% endblock %}