{% extends "base.html" %}
{% load mathfilters %}
{% block title %}Order #{{ order.id }} | Style Bazaar{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 dark:bg-gray-900 py-16 px-4 transition-all duration-700 ease-in-out">
    <div class="max-w-5xl mx-auto">
        <!-- Header -->
        <div class="text-center md:text-left mb-12 transition-colors duration-500">
            <h1 class="text-5xl md:text-6xl font-extrabold text-gray-900 dark:text-white mb-4">
                Order Details
            </h1>
            <p class="text-xl md:text-2xl text-gray-600 dark:text-gray-300">
                Placed on {{ order.created_at|date:"F d, Y \a\t g:i A" }}
            </p>
        </div>

        <!-- Order Summary Card -->
        <div class="bg-white dark:bg-gray-800 rounded-3xl shadow-2xl overflow-hidden mb-12 transition-all duration-700">
            <!-- Gradient Header -->
            <div class="bg-gradient-to-r from-primary to-purple-700 dark:from-primary-hover dark:to-purple-800 p-10 text-white">
                <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-8">
                    <div>
                        <h2 class="text-4xl font-extrabold">Order #{{ order.id }}</h2>
                        <div class="mt-6 flex flex-wrap items-center gap-4">
                            <span class="inline-block px-8 py-3 bg-white/20 backdrop-blur rounded-full text-xl font-bold">
                                {{ order.get_status_display }}
                            </span>
                            {% if order.is_paid %}
                            <span class="inline-block px-8 py-3 bg-green-500/30 rounded-full text-lg font-bold">
                                Paid
                            </span>
                            {% else %}
                            <span class="inline-block px-8 py-3 bg-yellow-500/30 rounded-full text-lg font-bold">
                                Awaiting Payment
                            </span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="text-center lg:text-right">
                        <p class="text-pink-100 text-lg opacity-90">Payment Method</p>
                        <p class="text-3xl font-extrabold mt-2">
                            {{ order.get_payment_method_display|default:"Not specified" }}
                        </p>
                    </div>
                </div>
            </div>

            <div class="p-10">
                <!-- Items Ordered -->
                <section class="mb-12">
                    <h3 class="text-3xl font-extrabold text-gray-900 dark:text-white mb-8">
                        Items Ordered ({{ order.items.count }})
                    </h3>
                    <div class="space-y-8">
                        {% for item in order.items.all %}
                        <div class="flex flex-col md:flex-row items-start md:items-center gap-8 bg-gray-50 dark:bg-gray-700/50 rounded-3xl p-8 hover:bg-gray-100 dark:hover:bg-gray-700 transition-all duration-300">
                            <div class="w-32 h-32 bg-white dark:bg-gray-800 rounded-2xl overflow-hidden shadow-lg flex-shrink-0">
                                {% if item.product.main_image %}
                                <img src="{{ item.product.main_image.url }}" alt="{{ item.product.name }}" class="w-full h-full object-cover">
                                {% else %}
                                <div class="w-full h-full flex items-center justify-center text-6xl">üõçÔ∏è</div>
                                {% endif %}
                            </div>

                            <div class="flex-1 space-y-4">
                                <div>
                                    <h4 class="text-2xl font-bold text-gray-900 dark:text-white">{{ item.product.name }}</h4>
                                    <p class="text-gray-600 dark:text-gray-400 mt-1">
                                        Seller: <span class="font-semibold text-primary">{{ item.product.seller.get_full_name|default:item.product.seller.username }}</span>
                                    </p>
                                </div>

                                <!-- Price & Promotion Display -->
                                <div class="space-y-2">
                                    <div class="flex items-center gap-4 text-lg">
                                        <span class="text-gray-700 dark:text-gray-300">Quantity:</span>
                                        <span class="font-bold text-gray-900 dark:text-white">{{ item.quantity }}</span>
                                    </div>

                                    <div class="flex flex-wrap items-center gap-4">
                                        <div>
                                            <span class="text-gray-700 dark:text-gray-300">Price:</span>
                                            <span class="text-2xl font-extrabold text-primary ml-2">
                                                K{{ item.price|floatformat:2 }} ZMW
                                            </span>
                                        </div>

                                        {% if item.original_price and item.original_price > item.price %}
                                        <div class="flex items-center gap-3">
                                            <span class="text-lg text-gray-500 dark:text-gray-400 line-through">
                                                K{{ item.original_price|floatformat:2 }}
                                            </span>
                                            <span class="bg-green-100 dark:bg-green-900/50 text-green-800 dark:text-green-300 px-3 py-1 rounded-full text-sm font-bold">
                                                {% if item.product.active_promotion.discount_type == 'percentage' %}
                                                    {{ item.product.active_promotion.discount_value }}% OFF
                                                {% else %}
                                                    K{{ item.product.active_promotion.discount_value|floatformat:2 }} OFF
                                                {% endif %}
                                            </span>
                                        </div>
                                        {% endif %}
                                    </div>

                                    {% if item.product.active_promotion and item.product.active_promotion.title %}
                                    <p class="text-sm italic text-gray-600 dark:text-gray-400">
                                        "{{ item.product.active_promotion.title }}"
                                    </p>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="text-right ml-auto">
                                <p class="text-sm text-gray-600 dark:text-gray-400 font-medium">Item Total</p>
                                <p class="text-3xl font-extrabold text-primary">
                                    K{{ item.get_total|floatformat:2 }} ZMW
                                </p>

                                {% if item.original_price and item.original_price > item.price %}
                                {% with savings=item.original_price|sub:item.price|mul:item.quantity %}
                                <p class="text-sm font-bold text-green-600 dark:text-green-400 mt-2">
                                    Saved K{{ savings|floatformat:2 }}
                                </p>
                                {% endwith %}
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </section>

                <!-- Pricing Breakdown -->
                <section class="border-t-4 border-dashed border-gray-200 dark:border-gray-700 pt-10">
                    <h3 class="text-3xl font-extrabold text-gray-900 dark:text-white mb-8">Order Summary</h3>
                    <div class="space-y-6 text-xl max-w-lg ml-auto">
                        <div class="flex justify-between">
                            <span class="text-gray-700 dark:text-gray-300">Subtotal</span>
                            <span class="font-bold text-gray-900 dark:text-white">K{{ order.get_items_total|floatformat:2 }}</span>
                        </div>
                        {% if order.discount_amount > 0 %}
                        <div class="flex justify-between text-green-600 dark:text-green-400 font-bold">
                            <span>Discount {% if order.coupon %}({{ order.coupon.code }}){% endif %}</span>
                            <span>-K{{ order.discount_amount|floatformat:2 }}</span>
                        </div>
                        {% endif %}
                        {% if order.delivery_price > 0 %}
                        <div class="flex justify-between">
                            <span class="text-gray-700 dark:text-gray-300">Delivery Fee</span>
                            <span class="font-bold text-gray-900 dark:text-white">K{{ order.delivery_price|floatformat:2 }}</span>
                        </div>
                        {% endif %}
                        <div class="border-t-4 border-primary pt-6 flex justify-between">
                            <span class="text-3xl font-extrabold text-gray-900 dark:text-white">Grand Total</span>
                            <span class="text-4xl font-extrabold text-primary">K{{ order.get_grand_total|floatformat:2 }}</span>
                        </div>
                    </div>
                </section>
            </div>
        </div>

        <!-- Delivery & Tracking -->
        <div class="grid md:grid-cols-2 gap-10 mb-12">
            <!-- Delivery Info -->
            <div class="bg-white dark:bg-gray-800 rounded-3xl shadow-2xl p-10 transition-all duration-500">
                <h3 class="text-3xl font-extrabold text-gray-900 dark:text-white mb-8">Delivery Information</h3>
                <div class="space-y-8 text-lg">
                    <div>
                        <p class="text-gray-600 dark:text-gray-400 font-medium">Delivery Method</p>
                        <p class="font-bold text-primary text-xl mt-2">
                            {{ order.delivery_option.name }}
                            {% if order.delivery_option.estimated_days %}
                            <span class="text-gray-700 dark:text-gray-300 font-normal text-lg">
                                ({{ order.delivery_option.estimated_days }} day{{ order.delivery_option.estimated_days|pluralize }} estimated)
                            </span>
                            {% endif %}
                        </p>
                    </div>
                    <div>
                        <p class="text-gray-600 dark:text-gray-400 font-medium">Shipping To</p>
                        <div class="mt-3 space-y-2">
                            <p class="font-bold text-gray-900 dark:text-white text-xl">{{ order.full_name }}</p>
                            <p class="text-gray-700 dark:text-gray-300">{{ order.phone }}</p>
                            <p class="text-gray-700 dark:text-gray-300 leading-relaxed">{{ order.address }}</p>
                            {% if order.gps_location %}
                            <p class="text-sm text-gray-500 dark:text-gray-400 mt-4 flex items-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                                </svg>
                                GPS: {{ order.gps_location }}
                            </p>
                            {% endif %}
                        </div>
                    </div>
                    {% if order.tracking_number %}
                    <div>
                        <p class="text-gray-600 dark:text-gray-400 font-medium">Tracking Number</p>
                        <p class="font-mono text-2xl font-bold text-primary mt-3">{{ order.tracking_number }}</p>
                    </div>
                    {% else %}
                    <p class="text-gray-500 dark:text-gray-400 italic text-lg">
                        Tracking number will be provided once your order is shipped
                    </p>
                    {% endif %}
                </div>
            </div>

            <!-- Order Status Timeline -->
            <div class="bg-white dark:bg-gray-800 rounded-3xl shadow-2xl p-10 transition-all duration-500">
                <h3 class="text-3xl font-extrabold text-gray-900 dark:text-white mb-10">Order Status</h3>
                <div class="space-y-10">
                    <div class="flex items-center gap-6">
                        <div class="w-14 h-14 rounded-full bg-primary flex items-center justify-center text-white text-2xl font-bold shadow-lg">‚úì</div>
                        <div>
                            <p class="text-xl font-bold text-gray-900 dark:text-white">Order Placed</p>
                            <p class="text-gray-600 dark:text-gray-400">{{ order.created_at|date:"M d, Y \a\t g:i A" }}</p>
                        </div>
                    </div>

                    {% if order.status in "confirmed,processing,shipped,delivered" %}
                    <div class="flex items-center gap-6">
                        <div class="w-14 h-14 rounded-full bg-primary flex items-center justify-center text-white text-2xl font-bold shadow-lg">‚úì</div>
                        <div>
                            <p class="text-xl font-bold text-gray-900 dark:text-white">Confirmed</p>
                            <p class="text-gray-600 dark:text-gray-400">Payment received and order confirmed</p>
                        </div>
                    </div>
                    {% endif %}

                    {% if order.status in "processing,shipped,delivered" %}
                    <div class="flex items-center gap-6">
                        <div class="w-14 h-14 rounded-full bg-primary flex items-center justify-center text-white text-2xl font-bold shadow-lg">‚úì</div>
                        <div>
                            <p class="text-xl font-bold text-gray-900 dark:text-white">Processing</p>
                            <p class="text-gray-600 dark:text-gray-400">Your items are being prepared</p>
                        </div>
                    </div>
                    {% endif %}

                    {% if order.status in "shipped,delivered" %}
                    <div class="flex items-center gap-6">
                        <div class="w-14 h-14 rounded-full bg-primary flex items-center justify-center text-white text-2xl font-bold shadow-lg">‚úì</div>
                        <div>
                            <p class="text-xl font-bold text-gray-900 dark:text-white">Shipped</p>
                            <p class="text-gray-600 dark:text-gray-400">Your package is on its way!</p>
                        </div>
                    </div>
                    {% endif %}

                    {% if order.status == "delivered" %}
                    <div class="flex items-center gap-6">
                        <div class="w-14 h-14 rounded-full bg-green-600 dark:bg-green-500 flex items-center justify-center text-white text-2xl font-bold shadow-lg">‚úì</div>
                        <div>
                            <p class="text-xl font-bold text-gray-900 dark:text-white">Delivered</p>
                            <p class="text-gray-600 dark:text-gray-400">Enjoy your purchase!</p>
                        </div>
                    </div>
                    {% endif %}

                    {% if order.status == "cancelled" %}
                    <div class="text-center py-8">
                        <p class="text-2xl font-bold text-red-600 dark:text-red-400">This order was cancelled</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex flex-col sm:flex-row gap-6 justify-center mb-12">
            <a href="{% url 'orders:order_list' %}" 
               class="inline-flex items-center justify-center gap-3 bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-white px-10 py-5 rounded-2xl font-bold text-xl hover:bg-gray-200 dark:hover:bg-gray-600 transition shadow-lg">
                ‚Üê Back to My Orders
            </a>

            {% if order.status in 'processing,shipped,delivered' or order.tracking_number %}
            <a href="{% url 'orders:buyer_order_tracking' order.id %}"
               class="inline-flex items-center justify-center gap-3 bg-primary text-white px-10 py-5 rounded-2xl font-bold text-xl hover:bg-primary-hover transition shadow-2xl transform hover:-translate-y-1">
                Track Order
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                </svg>
            </a>
            {% endif %}
        </div>

        <!-- Support CTA -->
        <div class="text-center">
            <p class="text-xl text-gray-600 dark:text-gray-400 mb-6">Need help with this order?</p>
            <a href="{% url 'support' %}" 
               class="inline-flex items-center gap-3 bg-gradient-to-r from-primary to-purple-700 text-white px-12 py-6 rounded-2xl font-bold text-xl hover:shadow-2xl transition transform hover:-translate-y-1">
                Contact Support
            </a>
        </div>
    </div>
</div>
{% endblock %}