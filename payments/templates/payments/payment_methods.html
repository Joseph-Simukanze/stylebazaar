{% extends "base.html" %}
{% block title %}My Payment Methods | Style Bazaar{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 py-12 px-4">
    <div class="max-w-5xl mx-auto">
        <div class="mb-10 flex items-center justify-between">
            <div>
                <h1 class="text-4xl md:text-5xl font-extrabold text-gray-900">Payment Methods</h1>
                <p class="text-xl text-gray-600 mt-3">Save your preferred ways to pay</p>
            </div>
        </div>

        <div class="grid lg:grid-cols-2 gap-10">
            <!-- Saved Methods -->
            <div>
                <h2 class="text-2xl font-bold text-gray-900 mb-6">Saved Methods</h2>

                {% if saved_methods %}
                <div class="space-y-4">
                    {% for method in saved_methods %}
                    <div class="bg-white rounded-2xl shadow-lg p-6 flex items-center justify-between {% if method.is_default %}ring-4 ring-pink-200{% endif %}">
                        <div class="flex items-center gap-5">
                            <div class="w-14 h-14 bg-pink-100 rounded-full flex items-center justify-center text-2xl">
                                {% if method.method.method == 'mobile_money' %}ðŸ“±{% else %}ðŸ’³{% endif %}
                            </div>
                            <div>
                                <p class="text-lg font-bold text-gray-900">{{ method.name }}</p>
                                <p class="text-gray-700">{{ method.display_details }}</p>
                                {% if method.is_default %}
                                <span class="inline-block mt-2 px-3 py-1 bg-pink-600 text-white text-xs rounded-full">DEFAULT</span>
                                {% endif %}
                            </div>
                        </div>

                        <div class="flex items-center gap-3">
                            {% if not method.is_default %}
                            <form action="" method="post" class="inline">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="set_default">
                                <input type="hidden" name="method_id" value="{{ method.id }}">
                                <button type="submit" class="text-pink-600 font-medium hover:underline">Set Default</button>
                            </form>
                            {% endif %}

                            <form action="" method="post" class="inline">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="delete">
                                <input type="hidden" name="method_id" value="{{ method.id }}">
                                <button type="submit" onclick="return confirm('Remove this method?')" class="text-red-600 hover:text-red-700">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                    </svg>
                                </button>
                            </form>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="bg-white rounded-3xl shadow-lg p-12 text-center">
                    <div class="text-8xl mb-6">ðŸ’³</div>
                    <p class="text-xl text-gray-600">No saved payment methods yet</p>
                    <p class="text-gray-500 mt-2">Add a mobile money number or bank card below to get started.</p>
                </div>
                {% endif %}
            </div>

            <!-- Add New Payment Method -->
            <div>
                <h2 class="text-2xl font-bold text-gray-900 mb-6">Add New Payment Method</h2>

                <div class="bg-white rounded-3xl shadow-lg overflow-hidden">
                    <div class="border-b border-gray-200">
                        <nav class="flex -mb-px">
                            <button type="button" onclick="switchTab('mobile')" class="tab-btn active w-1/2 py-4 px-6 text-center font-medium text-pink-600 border-b-2 border-pink-600" id="mobile-tab">
                                ðŸ“± Mobile Money
                            </button>
                            <button type="button" onclick="switchTab('card')" class="tab-btn w-1/2 py-4 px-6 text-center font-medium text-gray-500 border-b-2 border-transparent" id="card-tab">
                                ðŸ’³ Bank Card
                            </button>
                        </nav>
                    </div>

                    <!-- Mobile Money Form -->
                    <div id="mobile-form" class="tab-content p-8">
                        <p class="text-gray-600 mb-6">Choose your mobile money provider:</p>

                        <form method="post">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="add_mobile">

                            <div class="space-y-6">
                                <!-- Beautiful Network Cards -->
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    {% for provider in mobile_providers %}
                                    <label class="provider-card cursor-pointer">
                                        <input type="radio" name="provider" value="{{ provider.id }}" class="sr-only peer" required
                                               data-prefixes="{{ provider.prefixes|default:'' }}"
                                               data-name="{{ provider.display_name }}">
                                        <div class="bg-white border-2 border-gray-200 rounded-2xl p-6 text-center transition-all hover:shadow-xl peer-checked:border-pink-600 peer-checked:ring-4 peer-checked:ring-pink-100">
                                            <img src="{{ provider.logo_url|default:'' }}" alt="{{ provider.display_name }} Logo" class="h-24 mx-auto object-contain mb-4">
                                            <p class="text-lg font-bold text-gray-900">{{ provider.display_name }}</p>
                                        </div>
                                    </label>
                                    {% endfor %}
                                </div>

                                <!-- Selected Provider Info -->
                                <div id="selected-provider-info" class="hidden text-center mt-4">
                                    <p class="text-gray-700 font-medium">Selected: <span id="selected-name" class="text-pink-600"></span></p>
                                </div>

                                <!-- Phone Number Input -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Phone Number</label>
                                    <div class="relative">
                                        <input type="tel" id="phone-input" name="phone" placeholder="e.g., 0977123456" maxlength="10"
                                               class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-pink-500 focus:border-pink-500" required>
                                        <span id="prefix-hint" class="absolute left-4 top-3 text-gray-500 text-lg font-medium pointer-events-none"></span>
                                    </div>
                                    <p class="mt-2 text-sm text-gray-500">Enter your 10-digit number (including prefix like 097...)</p>
                                </div>

                                <!-- Save As -->
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Save as (optional)</label>
                                    <input type="text" name="name" placeholder="e.g., My Airtel Number" class="w-full border border-gray-300 rounded-lg px-4 py-3">
                                </div>
                            </div>

                            <button type="submit" class="mt-8 w-full bg-pink-600 text-white py-4 rounded-xl font-bold hover:bg-pink-700 transition shadow-lg">
                                Save Mobile Number
                            </button>
                        </form>
                    </div>

                    <!-- Bank Card Form (unchanged) -->
                    <div id="card-form" class="tab-content p-8 hidden">
                        <p class="text-gray-600 mb-6">Add your debit or credit card securely.</p>
                        <form method="post">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="add_card">
                            <div class="space-y-5">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Card Number</label>
                                    <input type="text" name="card_number" placeholder="1234 5678 9012 3456" maxlength="19" class="w-full border border-gray-300 rounded-lg px-4 py-3" required>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Expiry Date</label>
                                        <input type="text" name="expiry" placeholder="MM/YY" maxlength="5" class="w-full border border-gray-300 rounded-lg px-4 py-3" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">CVV</label>
                                        <input type="text" name="cvv" placeholder="123" maxlength="4" class="w-full border border-gray-300 rounded-lg px-4 py-3" required>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Cardholder Name</label>
                                    <input type="text" name="cardholder_name" placeholder="John Doe" class="w-full border border-gray-300 rounded-lg px-4 py-3" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Save as (optional)</label>
                                    <input type="text" name="name" placeholder="e.g., My Visa Card" class="w-full border border-gray-300 rounded-lg px-4 py-3">
                                </div>
                            </div>
                            <button type="submit" class="mt-8 w-full bg-pink-600 text-white py-4 rounded-xl font-bold hover:bg-pink-700 transition shadow-lg">
                                Save Card
                            </button>
                        </form>
                        <p class="mt-4 text-xs text-gray-500 text-center">
                            ðŸ”’ Your card details are encrypted and never stored on our servers.
                        </p>
                    </div>
                </div>

                <p class="mt-6 text-center text-sm text-gray-600">
                    Your payment information is saved securely and used only for transactions on Style Bazaar.
                </p>
            </div>
        </div>
    </div>
</div>

<script>
function switchTab(tab) {
    document.getElementById('mobile-tab').classList.remove('text-pink-600', 'border-pink-600');
    document.getElementById('mobile-tab').classList.add('text-gray-500', 'border-transparent');
    document.getElementById('card-tab').classList.remove('text-pink-600', 'border-pink-600');
    document.getElementById('card-tab').classList.add('text-gray-500', 'border-transparent');

    if (tab === 'mobile') {
        document.getElementById('mobile-tab').classList.add('text-pink-600', 'border-pink-600');
        document.getElementById('mobile-tab').classList.remove('text-gray-500', 'border-transparent');
        document.getElementById('mobile-form').classList.remove('hidden');
        document.getElementById('card-form').classList.add('hidden');
    } else {
        document.getElementById('card-tab').classList.add('text-pink-600', 'border-pink-600');
        document.getElementById('card-tab').classList.remove('text-gray-500', 'border-transparent');
        document.getElementById('card-form').classList.remove('hidden');
        document.getElementById('mobile-form').classList.add('hidden');
    }
}

// Handle provider selection and phone prefix hint
document.querySelectorAll('.provider-card input[type="radio"]').forEach(radio => {
    radio.addEventListener('change', function() {
        const prefixes = this.dataset.prefixes.split(',');
        const name = this.dataset.name;
        const phoneInput = document.getElementById('phone-input');
        const prefixHint = document.getElementById('prefix-hint');
        const selectedInfo = document.getElementById('selected-provider-info');
        const selectedName = document.getElementById('selected-name');

        if (this.checked) {
            selectedName.textContent = name;
            selectedInfo.classList.remove('hidden');

            // Show primary prefix as hint
            const primaryPrefix = prefixes[0].trim();
            prefixHint.textContent = primaryPrefix;

            // Adjust input padding and set placeholder
            phoneInput.style.paddingLeft = '4.5rem';
            phoneInput.placeholder = 'Enter the remaining 7 digits';

            // If input is empty or doesn't start with prefix, prefill prefix
            if (!phoneInput.value || !phoneInput.value.startsWith(primaryPrefix)) {
                phoneInput.value = primaryPrefix;
            }
        }
    });
});

// Clear hint when input is focused (for manual editing)
document.getElementById('phone-input').addEventListener('focus', function() {
    document.getElementById('prefix-hint').textContent = '';
    this.style.paddingLeft = '1rem';
});

// Restore hint on blur if no other provider selected
document.getElementById('phone-input').addEventListener('blur', function() {
    const checkedRadio = document.querySelector('.provider-card input[type="radio"]:checked');
    if (checkedRadio) {
        const primaryPrefix = checkedRadio.dataset.prefixes.split(',')[0].trim();
        document.getElementById('prefix-hint').textContent = primaryPrefix;
        this.style.paddingLeft = '4.5rem';
    }
});
</script>
{% endblock %}